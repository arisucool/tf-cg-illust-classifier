<!DOCTYPE html>
<html lang="ja">
    <head>

        <title>tf-cg-illust-classifier</title>

        <meta charset="utf8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

        <!-- Tensorflow.js -->
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
        <!---->

        <!-- Materialize -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <!---->

        <!-- Example script -->
        <script type="text/javascript">

            class Example {

                constructor() {

                    this.MODEL_URL = 'tfjs/model.json';
                    this.METADATA_URL = 'tfjs/metadata.json';

                }

                async init() {

                    // Set an event handler
                    document.getElementById('imageFileChooser').addEventListener('change', (event) => {

                        this.loadImage(event.target.files[0]);

                    }, false);

                    console.log(tmImage);

                    // Load the model
                    this.model = await tmImage.load(this.MODEL_URL, this.METADATA_URL);
                    this.maxPredictions = this.model.getTotalClasses();

                    // Generate an canvas
                    this.canvas = document.createElement('canvas');
                    this.canvas.width = 224;
                    this.canvas.height = 224;
                    this.ctx = this.canvas.getContext('2d');

                }

                async loadImage(file) {

                    // Clear results
                    this.clearResult();

                    // Check the file type
                    if (!file.type.match('image.*')) { // If not an image file
                        return window.alert('Please choose image files.');
                    }

                    // Load the image file
                    const reader = new FileReader();
                    reader.onload = async () => {

                        //const img = document.createElement('img');
                        //img.src = reader.result;
                        const img = new Image();
                        img.onload = async (event) => {

                            // Resize and crop
                            this.drawImageProp(this.ctx, img, 0, 0, 224, 224);

                            // Pre-process for classification
                            tf.tidy(() => {

                                let pixels = tf.browser.fromPixels(this.canvas);
                                pixels = pixels.expandDims(0);

                                // Normalize
                                return pixels.toFloat().div(tf.scalar(127)).sub(tf.scalar(1));

                            });

                            // Show the image
                            document.getElementById('choosedImage').src = this.canvas.toDataURL();

                            // Show the result card
                            document.getElementById('resultCard').style.display = 'block';

                            // Classify
                            const result = await this.classify();

                            // Show results - Label
                            document.getElementById('resultClassifiedLabel').innerText = result.classified.className;

                            // Show results - Prediction
                            const ul = document.getElementById('resultPredictionList');
                            for (const pred of result.prediction) {
                                const li = document.createElement('li');
                                li.innerText = pred.className + ': ' + pred.probability;
                                ul.appendChild(li);
                            }

                        };
                        img.src = reader.result;

                    };
                    reader.readAsDataURL(file);

                }

                // Thanks to https://stackoverflow.com/a/21961894
                drawImageProp(ctx, img, x, y, w, h, offsetX, offsetY) {

                    if (arguments.length === 2) {
                        x = y = 0;
                        w = ctx.canvas.width;
                        h = ctx.canvas.height;
                    }

                    // default offset is center
                    offsetX = typeof offsetX === "number" ? offsetX : 0.5;
                    offsetY = typeof offsetY === "number" ? offsetY : 0.5;

                    // keep bounds [0.0, 1.0]
                    if (offsetX < 0) offsetX = 0;
                    if (offsetY < 0) offsetY = 0;
                    if (offsetX > 1) offsetX = 1;
                    if (offsetY > 1) offsetY = 1;

                    var iw = img.width,
                        ih = img.height,
                        r = Math.min(w / iw, h / ih),
                        nw = iw * r,   // new prop. width
                        nh = ih * r,   // new prop. height
                        cx, cy, cw, ch, ar = 1;

                    // decide which gap to fill
                    if (nw < w) ar = w / nw;
                    if (Math.abs(ar - 1) < 1e-14 && nh < h) ar = h / nh;  // updated
                    nw *= ar;
                    nh *= ar;

                    // calc source rectangle
                    cw = iw / (nw / w);
                    ch = ih / (nh / h);

                    cx = (iw - cw) * offsetX;
                    cy = (ih - ch) * offsetY;

                    // make sure source rectangle is valid
                    if (cx < 0) cx = 0;
                    if (cy < 0) cy = 0;
                    if (cw > iw) cw = iw;
                    if (ch > ih) ch = ih;

                    // fill image in dest. rectangle
                    ctx.drawImage(img, cx, cy, cw, ch,  x, y, w, h);
                }

                clearResult() {

                    // Clear results - Label
                    document.getElementById('resultClassifiedLabel').innerText = '';

                    // Clear results - Prediction
                    const ul = document.getElementById('resultPredictionList');
                    while (ul.firstChild) {
                        ul.removeChild(ul.lastChild);
                    }

                }

                async classify() {

                    const prediction = await this.model.predict(this.canvas);

                    let classified = null;
                    for (const pred of prediction) {
                        if (!classified || classified.probability < pred.probability) {
                            classified = pred;
                        }
                    }

                    if (classified == null) {
                        return;
                    }

                    return {
                        classified: classified,
                        prediction: prediction
                    };

                }

            }

            window.addEventListener('DOMContentLoaded', (event) => {

                const example = new Example();
                example.init();

            });

        </script>
        <!---->

    </head>
    <body>

        <!-- Header -->
        <nav class="light-blue lighten-2" role="navigation">
          <div class="nav-wrapper container">
              <a id="logo-container" href="https://github.com/arisucool/tf-cg-illust-classifier" class="brand-logo">tf-cg-illust-classifier</a>
          </div>
        </nav>
        <!---->

        <div class="row">

            <!-- Card -->
            <div class="col s12 m6">
                <div class="card grey lighten-4">
                    <div class="card-content black-text">
                        <span class="card-title">Let try classification</span>

                        <p>
                            Please choose an image (e.g. illustration, screenshots, or photos) from your local file. <br />
                            Don't worry. No files are uploaded or saved to any server.
                        </p>

                        <!-- Image Chooser -->
                        <div class="file-field input-field">
                            <div class="btn">
                                <span>Choose</span>
                                <input type="file" id="imageFileChooser">
                            </div>
                            <div class="file-path-wrapper">
                                <input class="file-path validate" type="text" placeholder="Choose an image file (.jpg, .png)" style="color: #888;">
                            </div>
                        </div>
                        <!---->

                        <!-- Choosed image -->
                        <p style="text-align: center;">
                            <img id="choosedImage" style="width: 224px;">
                        </p>
                        <!---->

                    </div>
                </div>
            </div>
            <!---->

            <!-- Result Card -->
            <div id="resultCard" class="col s12 m6" style="display: none;">
                <div class="card grey lighten-4">
                    <div class="card-content black-text">
                        <span class="card-title">
                            Result:&nbsp;&nbsp;
                            <span id="resultClassifiedLabel"></span>
                        </span>
                        <p>
                            <ul id="resultPredictionList"></ul>
                        </p>
                    </div>
                </div>
            </div>
            <!---->

        </div>
    </body>
</html>
